  document.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });
}

// Mobile joystick
const joystickContainer = document.getElementById('joystickContainer');
const joystickThumb = document.getElementById('joystick');
joystickContainer.addEventListener('touchstart', e => { joystick.active=true; updateJoystick(e.touches[0]); });
joystickContainer.addEventListener('touchmove', e => { e.preventDefault(); updateJoystick(e.touches[0]); });
joystickContainer.addEventListener('touchend', e => { joystick.active=false; joystick.x=0; joystick.y=0; joystickThumb.style.transform='translate(25px,25px)'; });

function updateJoystick(touch) {
  let rect = joystickContainer.getBoundingClientRect();
  let x = touch.clientX - rect.left - rect.width/2;
  let y = touch.clientY - rect.top - rect.height/2;
  let max = rect.width/2;
  joystick.x = Math.max(-1, Math.min(1, x/max));
  joystick.y = Math.max(-1, Math.min(1, y/max));
  joystickThumb.style.transform = `translate(${25 + joystick.x*25}px, ${25 + joystick.y*25}px)`;
}

function update() {
  if(platform==='pc'){
    if(keys['a'] && player.x>0) player.x -= player.speed;
    if(keys['d'] && player.x+player.width<canvas.width) player.x += player.speed;
    if(keys['w'] && player.y>0) player.y -= player.speed;
    if(keys['s'] && player.y+player.height<canvas.height) player.y += player.speed;
  } else {
    player.x += joystick.x * player.speed;
    player.y += joystick.y * player.speed;
    if(player.x<0) player.x=0;
    if(player.x+player.width>canvas.width) player.x=canvas.width-player.width;
    if(player.y<0) player.y=0;
    if(player.y+player.height>canvas.height) player.y=canvas.height-player.height;
  }

  bullets.forEach((b,i) => {
    b.y -= b.speed;
    if(b.y < -b.height) bullets.splice(i,1);
  });

  meteors.forEach((m,j) => {
    m.y += m.speed;
    if(m.y - m.radius > canvas.height) meteors.splice(j,1);
    bullets.forEach((b,k)=>{
      let dx = b.x + b.width/2 - m.x;
      let dy = b.y + b.height/2 - m.y;
      if(Math.sqrt(dx*dx + dy*dy) < m.radius){
        meteors.splice(j,1);
        bullets.splice(k,1);
      }
    });
  });
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Player
  ctx.fillStyle='cyan';
  ctx.fillRect(player.x, player.y, player.width, player.height);

  // Bullets
  ctx.fillStyle='yellow';
  bullets.forEach(b=> ctx.fillRect(b.x,b.y,b.width,b.height));

  // Meteors
  ctx.fillStyle='red';
  meteors.forEach(m=> {
    ctx.beginPath();
    ctx.arc(m.x,m.y,m.radius,0,Math.PI*2);
    ctx.fill();
  });
}

function gameLoop() {
  if(!gameStarted) return;
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>

</body>
</html>
